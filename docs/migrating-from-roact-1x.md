# Migrating From Roact 1.x


## Minimum Requirements

When upgrading to Roact 17+, uses of certain legacy patterns and features need to be cleaned up entirely to maintain correct behavior. Once these conditions are met, your legacy Roact code should work as expected in Roact 17.

### No Reserved Props

In Roact 17, components cannot rely on any reserved prop keywords:

* "ref" - reserved by Roact to assign refs, equivalent to legacy Roact's `Roact.Ref`
* "key" - reserved by Roact to assign stable keys to children
* "children" - reserved by Roact as a special prop representing the children passed down to the component

If your component is using "ref" or "key" as the name of one of its props, it will no longer be populated with a value in Roact 17+. If it's using "children" as the name of one of its props, it will be populated with the table of child elements instead of any passed-in value.

### No Legacy Context

Legacy Roact implemented a `_context` field on all component instances as an alternative implementation for the Context feature. This is deprecated in legacy Roact and is not supported in Roact 17+.

Instead, use the [Provider and Consumer pattern via `createContext`](https://roblox.github.io/roact/advanced/context/). The `createContext` API is available in legacy Roact 1.3.0 (or newer) and is fully supported in Roact 17.

### Explicit Ref Forwarding

Legacy Roact uses `Roact.Ref` as a special prop key to support the refs feature. Assigning the `[Roact.Ref]` property to a callback ref or ref object allows Roact to assign its value. However, Roact only interacts with the `Roact.Ref` property if the component receiving the props is a host component.

Some class component definitions rely on this behavior by accepting and reassigning the `[Roact.Ref]` prop themselves, knowing that Roact won't capture it. This pattern is called "ref forwarding", and is supported explicitly with the `React.forwardRef` API.

In Roact 17+, `Roact.Ref` is aliased to the string "ref", and refs that point to class components are now supported. Components that were forwarding refs using the above method will now fail to forward their provided refs. To fix this, use the [`forwardRef` function](https://roblox.github.io/roact/advanced/bindings-and-refs/#ref-forwarding).

The `forwardRef` API is available in legacy Roact 1.4.0 (or newer) and is fully supported in Roact 17.

### Prefer getDerivedStateFromProps
Legacy Roact allows class components to implement both `willUpdate` and `getDerivedStateFromProps` lifecycle methods.

React JS, however, does not support both methods when implemented on the same component. When `getDerivedStateFromProps` is defined, it _replaces_ `componentWillUpdate` entirely. **Roact 17 inherits this restriction.**

In order to migrate existing components, make sure to use _either_ `willUpdate` or `getDerivedStateFromProps`, but not both. Whenever possible, use `getDerivedStateFromProps` to resolve interactions between state and props. As in React JS, `componentWillUpdate` is a legacy lifecycle method and should be avoided as [it can exacerbate problems with asynchronous rendering.

Refer to the React JS guidance on [migrating away from legacy lifecycle methods](https://reactjs.org/blog/2018/03/27/update-on-async-rendering.html).

## Adding a Roact 17 Dependency
Roact 17 is available as a collection of packages hosted in the https://github.com/roblox/roact-alignment repository. Internal Roblox processes use a package manager called [Rotriever](https://github.com/roblox/rotriever) to resolve and manage dependencies.

!!! info
	Roact 17 is a "package workspace", meaning that it consists of multiple packages living in the same project. We recommend using Rotriever version [0.5.0-rc.4](https://github.com/Roblox/rotriever/releases/tag/v0.5.0-rc.4) or newer to make sure it has workspace support.

	Refer to [Rotriever's documentation](https://roblox.github.io/rotriever/installation/) for more information on how to install or upgrade your version.

### New Projects

1. Make sure you're using rotriever version `0.5.0-rc.4` or newer. You can check this by running `rotrieve -V`.
2. Add the following to your `rotriever.toml` manifest file:
	```toml
	[dependencies]
	React = "github.com/roblox/roact-alignment@17.0.1-rc.8"
	ReactRoblox = "github.com/roblox/roact-alignment@17.0.1-rc.8"
	```
3. Run `rotrieve install` to install all dependencies
4. `React.lua` and `ReactRoblox.lua` will be added to the `Packages` folder generated by rotriever in your project. Make sure this folder is included in your project when testing with `roblox-cli` or Roblox Studio.

### Replacing Legacy Roact
The easiest way to adopt Roact 17 in an existing Roact project is to change your existing dependency on legacy Roact.

Make the following changes to your `rotriever.toml` manifest file:
```diff
[dependencies]
- Roact = "github.com/roblox/roact@1.4"
+ Roact = { target = "github.com/roblox/roact-alignment", version = "17.0.1-rc.8", package = "RoactCompat" }
```

This creates a dependency on the `RoactCompat` package, which provides [a compatibility layer](api-reference/roact-compat.md) for migrating from legacy APIs. Since it's still named `Roact` in the above snippet, it will be aliased to `Roact` in your code and will not require any changes to your source code.

However, the `RoactCompat` API only covers enough to provide backwards compatibility. To access new features like hooks or suspense, add dependencies on `React` and `ReactRoblox` too:
```toml
[dependencies]
Roact = { target = "github.com/roblox/roact-alignment", version = "17.0.1-rc.8", package = "RoactCompat" }
React = "github.com/roblox/roact-alignment@17.0.1-rc.8"
ReactRoblox = "github.com/roblox/roact-alignment@17.0.1-rc.8"
```

!!! info
	Since we're not aliasing the `React` and `ReactRoblox` packages, we can define our dependencies using the shorthand format. Read up on [specifying Rotriever dependencies](https://roblox.github.io/rotriever/guide/specifying-dependencies/) for more information.

#### Patching Other Dependencies
One thing you may need to account for is any other dependencies that use Roact. If you have a dependency that has its own dependency on legacy Roact, you may need to use rotriever's `patch` feature to swap out the legacy version.

You may encounter this if you have existing dependencies on any of the following:

* [InfiniteScroller](https://github.com/Roblox/infinite-scroller) (supports Roact 17 in 0.8.0 and newer)
* [RoactFitComponents](https://github.com/roblox/roact-fit-components) (supports Roact 17 in 2.0.0 and newer)
* [RoactRodux](https://github.com/Roblox/roact-rodux) (supports Roact 17 in 0.4.1 and newer)
* [UIBlox](https://github.com/Roblox/uiblox) (supports Roact 17 on the latest master)
* Numerous other projects that depend on legacy Roact

To resolve this, you can patch over any dependencies on legacy Roact and align them with your newly-added version. Add this additional section to your `rotriever.toml` manifest file:
```toml
[config.patch."github.com/roblox/roact"]
Roact = { target = "github.com/roblox/roact-alignment", version = "17.0.1-rc.8", package = "RoactCompat" }
```

To learn more about patching dependencies, check out [the Rotriever documentation](https://roblox.github.io/rotriever/guide/specifying-dependencies/#patching-dependencies).

!!! caution
	When you're patching over Roact, make sure your other dependencies are compatible with Roact 17. They may need recent changes to comply with the [Roact 17 requirements](#minimum-requirements) specified above.

### Testing with Both
In some cases, you may not yet be ready to adopt Roact 17, but you want to start adopting it in tests or storybooks.

One reasonable way to accomplish this is to depend on _both_ projects, but to conditionally swap in Roact 17 at runtime. To do this, make sure your `rotriever.toml` manifest file contains the following:
```toml
[dependencies]
Roact = "github.com/roblox/roact@1.4"

[dev_dependencies]
RoactCompat = "github.com/roblox/roact-alignment@17.0.1-rc.8"
```

This declares a dependency on legacy Roact as well as a [dev dependency](https://roblox.github.io/rotriever/guide/specifying-dependencies/#development-dependencies) on Roact 17.

In your test runner script or other equivalent entry point, check the value of a global (or flag, or any other preferred configuration method), and overwrite the `Roact` API with that of `RoactCompat` when enabled. It may look something like this:

```lua
if _G.__NEW_ROACT__ then
	local Roact = require(Packages.Roact)
	local RoactCompat = require(Packages.Dev.RoactCompat)

	-- Overwrite the contents of the `Roact` package with that of the
	-- RoactCompat package
	for api, _ in pairs(Roact) do
		Roact[api] = RoactCompat[api]
	end
end

-- Proceed with test setup...
```

To see this logic in context, you can find a comprehensive example [in the UIBlox library](https://github.com/Roblox/uiblox/blob/master/bin/run-tests.server.lua).

## Adopting New Rendering Behavior
*Under construction ðŸ”¨*

In addition to newly added APIs, Roact 17 also includes changes to the underlying rendering behavior.

### ReactRoblox.createRoot

### ReactRoblox.act


## Configuration
*Under construction ðŸ”¨*

### Globals

## Updating Conventions and APIs
*Under construction ðŸ”¨*

While not necessary to function properly, some additional changes can be made to adopt the naming conventions and API shape of React JS.

### Component Lifecycle Names

### Context.Consumer

### Fragments

#### Implicit Fragments

#### React.Fragment


### ReactRoblox.createPortal

### Eliminating RoactCompat
h